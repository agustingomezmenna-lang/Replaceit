<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Replaceit</title>

  <!--
    ✅ Robust local loader:
    - Tries multiple filenames (supports accidental ".js.js")
    - Avoids CDN (works better with AdBlock / corporate networks)
  -->
  <script>
  (function () {
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = () => resolve(src);
        s.onerror = () => reject(new Error("Failed to load: " + src));
        document.head.appendChild(s);
      });
    }

    window.__LIBS_READY__ = (async () => {
      // Load strictly from local libs (no CDN)
      await loadScript("./libs/jszip.min.js");
      await loadScript("./libs/FileSaver.min.js");
      await loadScript("./libs/xlsx.full.min.js");
      return true;
    })();
  })();
</script>
      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = src;
          s.async = true;
          s.onload = () => resolve(src);
          s.onerror = () => reject(new Error("Failed to load: " + src));
          document.head.appendChild(s);
        });
      }

      async function loadFirstThatWorks(candidates) {
        let lastErr = null;
        for (const c of candidates) {
          try {
            await loadScript(c);
            return c;
          } catch (e) {
            lastErr = e;
          }
        }
        throw lastErr || new Error("No candidates worked");
      }

      // Expose a promise we can await later
      window.__LIBS_READY__ = (async () => {
        // JSZip
        await loadFirstThatWorks([
          "./libs/jszip.min.js",
          "./libs/jszip.min.js.js",
          "./libs/JSZip.min.js",
          "./libs/JSZip.min.js.js"
        ]);

        // FileSaver (saveAs)
        await loadFirstThatWorks([
          "./libs/FileSaver.min.js",
          "./libs/FileSaver.min.js.js",
          "./libs/filesaver.min.js",
          "./libs/filesaver.min.js.js"
        ]);

        // XLSX
        await loadFirstThatWorks([
          "./libs/xlsx.full.min.js",
          "./libs/xlsx.full.min.js.js",
          "./libs/xlsx.min.js",
          "./libs/xlsx.min.js.js",
          "./libs/core.min.js",
          "./libs/core.min.js.js"
        ]);

        return true;
      })();
    })();
  </script>

  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 18px 50px rgba(17,24,39,.10);
      --shadow2: 0 12px 30px rgba(17,24,39,.12);
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --navH: 72px;
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1200px 600px at 50% 0%, #ffffff 0%, var(--bg) 60%);
    }

    /* Top nav */
    .nav{
      position: sticky;
      top: 0;
      z-index: 50;
      height: var(--navH);
      background: rgba(255,255,255,.82);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229,231,235,.9);
      display:flex;
      align-items:center;
    }

    .nav-inner{
      width: min(1200px, calc(100% - 40px));
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      user-select:none;
    }

    .logo{
      width:44px;height:44px;
      border-radius: 14px;
      background: var(--blue);
      display:grid;place-items:center;
      color:white;
      font-weight: 900;
      letter-spacing:.5px;
      box-shadow: 0 10px 24px rgba(37,99,235,.25);
    }

    .brand-name{
      font-size: 20px;
      font-weight: 800;
      letter-spacing:-.3px;
    }

    .nav-right{
      display:flex;
      align-items:center;
      gap: 18px;
    }

    .nav-link{
      color: var(--muted);
      text-decoration:none;
      font-weight: 600;
      font-size: 14px;
    }
    .nav-link:hover{ color: var(--text); }

    .pill{
      border:1px solid var(--border);
      background: white;
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{ border-color:#cbd5e1; }

    .btn{
      border:1px solid var(--border);
      background: white;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 14px;
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .btn:hover{ border-color:#cbd5e1; }

    /* Tooltip "ahead" */
    .tooltip{
      position:absolute;
      top: 120%;
      right: 0;
      width: min(420px, 80vw);
      background: #0b1220;
      color: white;
      border-radius: 14px;
      padding: 14px 14px;
      box-shadow: 0 22px 60px rgba(0,0,0,.35);
      display:none;
    }
    .tooltip::before{
      content:"";
      position:absolute;
      top:-8px;
      right: 22px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #0b1220;
    }
    .btn:hover .tooltip{ display:block; }

    .tooltip h4{
      margin:0 0 6px 0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .tooltip p{
      margin:0;
      color: rgba(255,255,255,.82);
      font-size: 13px;
      line-height: 1.35;
    }
    .tooltip .email{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-weight: 700;
    }
    .tooltip .email a{
      color: white;
      text-decoration: none;
      font-weight: 900;
      white-space:nowrap;
    }

    /* Page layout */
    .wrap{
      width: min(1200px, calc(100% - 40px));
      margin: 0 auto;
      padding: 42px 0 48px;
    }

    .hero{
      text-align:center;
      margin: 44px 0 32px;
    }
    .hero h1{
      font-size: clamp(38px, 6vw, 64px);
      margin:0;
      letter-spacing:-1.5px;
      font-weight: 900;
    }
    .hero p{
      margin: 14px auto 0;
      max-width: 850px;
      color: var(--muted);
      font-size: 18px;
      line-height: 1.5;
      font-weight: 600;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 18px;
      margin-top: 34px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 22px;
      padding: 18px 18px 16px;
      box-shadow: 0 14px 44px rgba(17,24,39,.08);
      cursor:pointer;
      position:relative;
      overflow:hidden;
      min-height: 132px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(203,213,225,.95);
      box-shadow: 0 18px 60px rgba(17,24,39,.12);
    }

    .chip{
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
    }
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--blue);
      box-shadow: 0 0 0 4px rgba(37,99,235,.15);
    }

    .card h3{
      margin: 12px 0 6px;
      font-size: 22px;
      letter-spacing:-.4px;
    }
    .card p{
      margin:0;
      color: var(--muted);
      font-weight: 650;
      line-height:1.35;
    }

    /* Hover details for cards (no "Tip:", just actionables) */
    .card .hover-info{
      position:absolute;
      left: 16px;
      right: 16px;
      top: 16px;
      background: #0b1220;
      color: white;
      border-radius: 16px;
      padding: 14px 14px;
      box-shadow: 0 24px 70px rgba(0,0,0,.35);
      opacity:0;
      transform: translateY(6px);
      pointer-events:none;
      transition: opacity .12s ease, transform .12s ease;
      z-index: 5;
    }
    .card:hover .hover-info{
      opacity:1;
      transform: translateY(0px);
    }
    .hover-info .title{
      font-size: 14px;
      font-weight: 900;
      margin-bottom: 8px;
    }
    .hover-info .list{
      margin:0;
      padding-left: 18px;
      color: rgba(255,255,255,.85);
      font-size: 13px;
      line-height: 1.35;
      font-weight: 650;
    }

    /* Action page */
    .back{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: white;
      font-weight: 900;
      cursor:pointer;
      width: fit-content;
      user-select:none;
    }
    .back:hover{ border-color:#cbd5e1; }

    .action-title{
      text-align:center;
      margin: 18px 0 8px;
      font-size: clamp(34px, 5vw, 58px);
      letter-spacing:-1.2px;
      font-weight: 950;
    }
    .action-sub{
      text-align:center;
      color: var(--muted);
      font-weight: 650;
      font-size: 18px;
      margin: 0 0 26px;
    }

    .panel{
      background: white;
      border: 1px solid rgba(229,231,235,.95);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 22px;
      max-width: 980px;
      margin: 0 auto;
    }

    .drop{
      border: 2px dashed #cbd5e1;
      border-radius: 22px;
      padding: 34px;
      background: #fbfdff;
      text-align:center;
      position:relative;
    }

    .primary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 16px 22px;
      border-radius: 16px;
      border: 0;
      background: var(--blue);
      color:white;
      font-weight: 950;
      font-size: 18px;
      cursor:pointer;
      box-shadow: 0 16px 30px rgba(37,99,235,.24);
      transition: transform .08s ease, background .12s ease;
    }
    .primary:hover{ background: var(--blue2); transform: translateY(-1px); }

    .hint{
      margin-top: 12px;
      color: var(--muted);
      font-weight: 650;
    }

    .fileRow{
      margin: 18px auto 0;
      max-width: 760px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      border: 1px solid rgba(229,231,235,.95);
      background: white;
      border-radius: 18px;
      padding: 14px 16px;
      box-shadow: 0 12px 28px rgba(17,24,39,.06);
    }
    .fileMeta strong{
      display:block;
      font-size: 20px;
      letter-spacing:-.2px;
    }
    .fileMeta span{
      color: var(--muted);
      font-weight: 650;
      font-size: 14px;
    }
    .secondary{
      padding: 12px 18px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: white;
      font-weight: 900;
      cursor:pointer;
    }
    .secondary:hover{ border-color:#cbd5e1; }

    .actionsRow{
      display:flex;
      justify-content:flex-end;
      gap: 12px;
      margin-top: 18px;
      flex-wrap: wrap;
    }

    .cta{
      padding: 14px 20px;
      border-radius: 16px;
      border: 0;
      background: var(--blue);
      color:white;
      font-weight: 950;
      font-size: 18px;
      cursor:pointer;
      box-shadow: 0 16px 30px rgba(37,99,235,.24);
    }
    .cta:hover{ background: var(--blue2); }

    .log{
      margin-top: 16px;
      background: #0b1220;
      color:white;
      border-radius: 18px;
      padding: 16px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      min-height: 84px;
      box-shadow: var(--shadow2);
    }
    .log .bad{ color:#ff6b6b; font-weight:900; }
    .log .ok{ color:#7CFF9E; font-weight:900; }

    .footer{
      text-align:center;
      color: #6b7280;
      font-weight: 700;
      margin-top: 26px;
    }
  </style>
</head>

<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand" onclick="goHome()" style="cursor:pointer;">
        <div class="logo">RI</div>
        <div class="brand-name">Replaceit</div>
      </div>

      <div class="nav-right">
        <a class="nav-link" href="#tools" id="navTools">Herramientas</a>
        <a class="nav-link" href="#privacy" id="navPrivacy">Privacidad</a>

        <div class="pill" id="langBtn" onclick="toggleLang()">EN</div>

        <div class="btn" id="contactBtn">
          <span id="contactText">Contact</span>
          <div class="tooltip">
            <h4 id="contactTitle">Contacto</h4>
            <p id="contactDesc">¿Querés sugerir una herramienta o pedir una mejora?</p>
            <div class="email">
              <span>agustingomezmenna@gmail.com</span>
              <a href="mailto:agustingomezmenna@gmail.com" id="contactAction">Contactar</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- HOME -->
    <section id="homeView">
      <div class="hero">
        <h1 id="heroTitle">Excel Tools</h1>
        <p id="heroSub">
          Herramientas para solucionarte el día a día en tu trabajo. Subís un .xlsx, aplicás la acción, y descargás!
        </p>
      </div>

      <div class="grid" id="toolsGrid"></div>

      <div class="footer">© Replaceit</div>
    </section>

    <!-- ACTION -->
    <section id="actionView" style="display:none;">
      <div class="back" onclick="goHome()">
        <span>←</span>
        <span id="backText">Volver</span>
      </div>

      <h2 class="action-title" id="actionTitle">Acción</h2>
      <p class="action-sub" id="actionSubtitle">Subí un Excel y procesalo.</p>

      <div class="panel">
        <div class="drop" id="dropZone">
          <button class="primary" id="selectBtn" type="button"></button>
          <input id="fileInput" type="file" accept=".xlsx" style="display:none;" />

          <div class="hint" id="dropHint"></div>

          <div class="fileRow" id="fileRow" style="display:none;">
            <div class="fileMeta">
              <strong id="fileName">-</strong>
              <span id="fileInfo">-</span>
            </div>
            <button class="secondary" type="button" onclick="pickFile()" id="changeBtn">Cambiar</button>
          </div>
        </div>

        <div class="actionsRow">
          <button class="secondary" type="button" onclick="previewFile()" id="previewBtn">Previsualizar</button>
          <button class="cta" type="button" onclick="runTool()" id="runBtn">Procesar</button>
        </div>

        <div class="log" id="logBox"></div>
      </div>

      <div class="footer">© Replaceit</div>
    </section>
  </main>

  <script>
    // =======================
    // i18n
    // =======================
    const I18N = {
      es: {
        navTools: "Herramientas",
        navPrivacy: "Privacidad",
        contact: "Contact",
        contactTitle: "Contacto",
        contactDesc: "¿Querés sugerir una herramienta o pedir una mejora?",
        contactAction: "Contactar",
        heroTitle: "Excel Tools",
        heroSub: "Herramientas para solucionarte el día a día en tu trabajo. Subís un .xlsx, aplicás la acción, y descargás!",
        back: "Volver",
        select: "Seleccionar archivo Excel",
        dropHint: "o arrastrá y soltá el Excel aquí",
        change: "Cambiar",
        preview: "Previsualizar",
        run: "Procesar",
        processing: "Procesando…",
        ready: "Listo ✅",
        needFile: "Seleccioná un archivo .xlsx primero.",
        libsFail: "No se pudieron cargar librerías (XLSX/JSZip/FileSaver). Revisá /libs y nombres.",
        previewTitle: "Preview (primeras filas)",
        doneDownload: "Archivo listo. Descargando…",
        doneZip: "ZIP listo. Descargando…",
        tools: [
          {
            id: "dot_comma",
            chip: ". → ,",
            title: "Punto → Coma",
            desc: "Reemplaza “.” por “,” en celdas de texto.",
            hover: [
              "Convierte separadores decimales en texto.",
              "No toca valores numéricos (solo texto).",
              "Ideal para CSV/exports con formato incorrecto."
            ],
            actionTitle: "Punto → Coma",
            actionSub: "Reemplaza “.” por “,” en celdas de texto en todas las hojas."
          },
          {
            id: "comma_dot",
            chip: ", → .",
            title: "Coma → Punto",
            desc: "Reemplaza “,” por “.” en celdas de texto.",
            hover: [
              "Corrige separadores en texto para formato US.",
              "No toca valores numéricos (solo texto).",
              "Útil para reportes que vienen con coma."
            ],
            actionTitle: "Coma → Punto",
            actionSub: "Reemplaza “,” por “.” en celdas de texto en todas las hojas."
          },
          {
            id: "remove_$",
            chip: "$ → (vacío)",
            title: "Quitar $",
            desc: "Elimina el símbolo “$” en celdas de texto.",
            hover: [
              "Limpia importes pegados como texto.",
              "Deja el resto del contenido igual.",
              "Ideal para normalizar imports."
            ],
            actionTitle: "Quitar $",
            actionSub: "Elimina “$” en texto en todas las hojas."
          },
          {
            id: "usd",
            chip: "$ → USD",
            title: "$ → USD",
            desc: "Reemplaza “$” por “USD” en celdas de texto.",
            hover: [
              "Estándar rápido de moneda en texto.",
              "Útil para dashboards y parsing.",
              "No altera números."
            ],
            actionTitle: "$ → USD",
            actionSub: "Reemplaza “$” por “USD” en texto en todas las hojas."
          },
          {
            id: "trim",
            chip: "trim()",
            title: "Trim espacios",
            desc: "Quita espacios al inicio y al final en texto.",
            hover: [
              "Limpia “ Name ” → “Name”.",
              "Reduce errores de matching/joins.",
              "No altera el interior del texto."
            ],
            actionTitle: "Trim espacios",
            actionSub: "Recorta espacios al inicio/fin en texto, en todas las hojas."
          },
          {
            id: "normalize_spaces",
            chip: "spaces→1",
            title: "Normalizar espacios",
            desc: "Convierte múltiples espacios/tabs en un solo espacio.",
            hover: [
              "Colapsa dobles espacios automáticamente.",
              "Convierte tabs en un espacio.",
              "Ideal para nombres/direcciones en texto."
            ],
            actionTitle: "Normalizar espacios",
            actionSub: "Colapsa espacios y tabs múltiples en texto."
          },
          {
            id: "scale_1000",
            chip: "/ 1.000",
            title: "Escalar a miles",
            desc: "Divide todos los números por 1.000.",
            hover: [
              "1.000.000 → 1.000",
              "Aplica a celdas numéricas en todas las hojas.",
              "Mantiene fórmulas sin tocar (solo valores)."
            ],
            actionTitle: "Escalar a miles",
            actionSub: "Divide números por 1.000 (todas las hojas)."
          },
          {
            id: "scale_10000",
            chip: "/ 10.000",
            title: "Escalar a diez-miles",
            desc: "Divide todos los números por 10.000.",
            hover: [
              "1.000.000 → 100",
              "Aplica a celdas numéricas en todas las hojas.",
              "Mantiene fórmulas sin tocar (solo valores)."
            ],
            actionTitle: "Escalar a diez-miles",
            actionSub: "Divide números por 10.000 (todas las hojas)."
          },
          {
            id: "unify_sheets",
            chip: "N hojas → 1",
            title: "Unificar hojas (smart)",
            desc: "Une todas las hojas en una sola, alineando por headers.",
            hover: [
              "Detecta headers en la primera fila de cada hoja.",
              "Si 'name' está en otra columna, lo alinea igual.",
              "Salida: 1 hoja llamada “replaceit”."
            ],
            actionTitle: "Unificar hojas (smart)",
            actionSub: "Une todas las hojas en 1, alineando columnas por nombre de header."
          },
          {
            id: "split_sheets",
            chip: "1 → N excels",
            title: "Separar hojas",
            desc: "Crea un Excel por cada hoja y descarga un ZIP.",
            hover: [
              "Si tenés 9 hojas → 9 excels.",
              "Mantiene los datos de cada hoja.",
              "Entrega un ZIP listo."
            ],
            actionTitle: "Separar hojas",
            actionSub: "Crea un Excel por hoja y descarga un ZIP."
          },
        ]
      },

      en: {
        navTools: "Tools",
        navPrivacy: "Privacy",
        contact: "Contact",
        contactTitle: "Contact",
        contactDesc: "Want to suggest a tool or request an improvement?",
        contactAction: "Email",
        heroTitle: "Excel Tools",
        heroSub: "Tools to make your daily work easier. Upload a .xlsx, apply the action, and download!",
        back: "Back",
        select: "Select Excel file",
        dropHint: "or drag & drop the Excel here",
        change: "Change",
        preview: "Preview",
        run: "Process",
        processing: "Processing…",
        ready: "Done ✅",
        needFile: "Please select a .xlsx file first.",
        libsFail: "Libraries could not be loaded (XLSX/JSZip/FileSaver). Check /libs and filenames.",
        previewTitle: "Preview (first rows)",
        doneDownload: "File ready. Downloading…",
        doneZip: "ZIP ready. Downloading…",
        tools: [
          {
            id: "dot_comma",
            chip: ". → ,",
            title: "Dot → Comma",
            desc: "Replace “.” with “,” in text cells.",
            hover: [
              "Converts decimal separators in text.",
              "Does not touch numeric values (text only).",
              "Great for exports with wrong format."
            ],
            actionTitle: "Dot → Comma",
            actionSub: "Replace “.” with “,” in text cells across all sheets."
          },
          {
            id: "comma_dot",
            chip: ", → .",
            title: "Comma → Dot",
            desc: "Replace “,” with “.” in text cells.",
            hover: [
              "Fixes text separators for US format.",
              "Does not touch numeric values (text only).",
              "Useful when reports come with comma."
            ],
            actionTitle: "Comma → Dot",
            actionSub: "Replace “,” with “.” in text cells across all sheets."
          },
          {
            id: "remove_$",
            chip: "$ → (empty)",
            title: "Remove $",
            desc: "Remove “$” from text cells.",
            hover: [
              "Cleans amounts pasted as text.",
              "Keeps the rest untouched.",
              "Great for normalization."
            ],
            actionTitle: "Remove $",
            actionSub: "Remove “$” from text across all sheets."
          },
          {
            id: "usd",
            chip: "$ → USD",
            title: "$ → USD",
            desc: "Replace “$” with “USD” in text cells.",
            hover: [
              "Quick currency standard in text.",
              "Helpful for parsing and dashboards.",
              "Does not alter numbers."
            ],
            actionTitle: "$ → USD",
            actionSub: "Replace “$” with “USD” in text across all sheets."
          },
          {
            id: "trim",
            chip: "trim()",
            title: "Trim spaces",
            desc: "Trim leading/trailing spaces in text.",
            hover: [
              "Cleans “ Name ” → “Name”.",
              "Reduces matching/join issues.",
              "Does not change inner spaces."
            ],
            actionTitle: "Trim spaces",
            actionSub: "Trim leading/trailing spaces in text across all sheets."
          },
          {
            id: "normalize_spaces",
            chip: "spaces→1",
            title: "Normalize spaces",
            desc: "Collapse multiple spaces/tabs into one space.",
            hover: [
              "Collapses double spaces automatically.",
              "Turns tabs into a single space.",
              "Great for names/addresses in text."
            ],
            actionTitle: "Normalize spaces",
            actionSub: "Collapse multiple spaces/tabs into one in text cells."
          },
          {
            id: "scale_1000",
            chip: "/ 1,000",
            title: "Scale to thousands",
            desc: "Divide all numbers by 1,000.",
            hover: [
              "1,000,000 → 1,000",
              "Applies to numeric cells across all sheets.",
              "Keeps formulas untouched (values only)."
            ],
            actionTitle: "Scale to thousands",
            actionSub: "Divide numeric cells by 1,000 across all sheets."
          },
          {
            id: "scale_10000",
            chip: "/ 10,000",
            title: "Scale to ten-thousands",
            desc: "Divide all numbers by 10,000.",
            hover: [
              "1,000,000 → 100",
              "Applies to numeric cells across all sheets.",
              "Keeps formulas untouched (values only)."
            ],
            actionTitle: "Scale to ten-thousands",
            actionSub: "Divide numeric cells by 10,000 across all sheets."
          },
          {
            id: "unify_sheets",
            chip: "N sheets → 1",
            title: "Unify sheets (smart)",
            desc: "Merge all sheets into one, aligned by headers.",
            hover: [
              "Reads headers from row 1 in each sheet.",
              "Aligns columns even if positions differ.",
              "Output: single sheet named “replaceit”."
            ],
            actionTitle: "Unify sheets (smart)",
            actionSub: "Merge all sheets into one by header names."
          },
          {
            id: "split_sheets",
            chip: "1 → N excels",
            title: "Split sheets",
            desc: "Create one Excel per sheet and download a ZIP.",
            hover: [
              "If you have 9 sheets → 9 excels.",
              "Keeps each sheet’s data intact.",
              "Delivers a ZIP ready to use."
            ],
            actionTitle: "Split sheets",
            actionSub: "Create one Excel per sheet and download a ZIP."
          },
        ]
      }
    };

    let lang = "es";
    let selectedTool = null;
    let currentFile = null;

    // =======================
    // Render
    // =======================
    function $(id){ return document.getElementById(id); }

    function applyLang(){
      const t = I18N[lang];

      $("navTools").textContent = t.navTools;
      $("navPrivacy").textContent = t.navPrivacy;

      $("contactText").textContent = t.contact;
      $("contactTitle").textContent = t.contactTitle;
      $("contactDesc").textContent = t.contactDesc;
      $("contactAction").textContent = t.contactAction;

      $("heroTitle").textContent = t.heroTitle;
      $("heroSub").textContent = t.heroSub;

      $("backText").textContent = t.back;
      $("selectBtn").textContent = t.select;
      $("dropHint").textContent = t.dropHint;
      $("changeBtn").textContent = t.change;
      $("previewBtn").textContent = t.preview;
      $("runBtn").textContent = t.run;

      $("langBtn").textContent = (lang === "es") ? "EN" : "ES";

      renderTools();
      if (selectedTool) loadAction(selectedTool.id);
    }

    function renderTools(){
      const grid = $("toolsGrid");
      grid.innerHTML = "";
      const t = I18N[lang];

      for (const tool of t.tools){
        const card = document.createElement("div");
        card.className = "card";
        card.onclick = () => openTool(tool.id);

        card.innerHTML = `
          <div class="hover-info">
            <div class="title">${escapeHtml(tool.title)} — ${escapeHtml(tool.chip)}</div>
            <ul class="list">
              ${tool.hover.map(x => `<li>${escapeHtml(x)}</li>`).join("")}
            </ul>
          </div>

          <div class="chip">
            <span class="dot"></span>
            <span>${escapeHtml(tool.chip)}</span>
          </div>

          <h3>${escapeHtml(tool.title)}</h3>
          <p>${escapeHtml(tool.desc)}</p>
        `;
        grid.appendChild(card);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // =======================
    // Navigation
    // =======================
    function goHome(){
      selectedTool = null;
      $("homeView").style.display = "";
      $("actionView").style.display = "none";
      window.location.hash = "";
    }

    function openTool(id){
      selectedTool = { id };
      $("homeView").style.display = "none";
      $("actionView").style.display = "";
      window.location.hash = "tool/" + id;
      loadAction(id);
      clearFile();
      log("");
    }

    function loadAction(id){
      const t = I18N[lang];
      const tool = t.tools.find(x => x.id === id);
      if (!tool) return;

      $("actionTitle").textContent = tool.actionTitle || tool.title;
      $("actionSubtitle").textContent = tool.actionSub || tool.desc;
    }

    function toggleLang(){
      lang = (lang === "es") ? "en" : "es";
      applyLang();
    }

    // =======================
    // File handling
    // =======================
    function pickFile(){ $("fileInput").click(); }

    function clearFile(){
      currentFile = null;
      $("fileRow").style.display = "none";
      $("fileName").textContent = "-";
      $("fileInfo").textContent = "-";
      $("fileInput").value = "";
    }

    function setFile(file){
      currentFile = file;
      $("fileRow").style.display = "";
      $("fileName").textContent = file.name;
      $("fileInfo").textContent = `${(file.size/1024).toFixed(1)} KB • .xlsx`;
    }

    function setupDrop(){
      const dz = $("dropZone");
      dz.addEventListener("dragover", (e) => { e.preventDefault(); dz.style.background = "#f3f7ff"; });
      dz.addEventListener("dragleave", () => { dz.style.background = "#fbfdff"; });
      dz.addEventListener("drop", (e) => {
        e.preventDefault();
        dz.style.background = "#fbfdff";
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if (f) setFile(f);
      });

      $("selectBtn").addEventListener("click", pickFile);
      $("fileInput").addEventListener("change", (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) setFile(f);
      });
    }

    // =======================
    // Logging
    // =======================
    function log(text){
      $("logBox").textContent = text || "";
    }
    function logErr(text){
      $("logBox").innerHTML = `<span class="bad">ERROR ✗</span> ${escapeHtml(text)}`;
    }
    function logOk(text){
      $("logBox").innerHTML = `<span class="ok">OK ✓</span> ${escapeHtml(text)}`;
    }

    // =======================
    // XLSX Helpers
    // =======================
    async function ensureLibs(){
      const t = I18N[lang];
      try{
        await window.__LIBS_READY__;
      } catch(e){
        logErr(t.libsFail + "\n\n" + (e && e.message ? e.message : String(e)));
        return false;
      }

      const okXLSX = typeof window.XLSX !== "undefined";
      const okZip  = typeof window.JSZip !== "undefined";
      const okSave = typeof window.saveAs !== "undefined";

      if (!okXLSX || !okZip || !okSave){
        logErr(t.libsFail + `\n\nDetalle técnico:\nXLSX: ${typeof window.XLSX}\nJSZip: ${typeof window.JSZip}\nsaveAs: ${typeof window.saveAs}`);
        return false;
      }
      return true;
    }

    function readFileAsArrayBuffer(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(r.error || new Error("FileReader error"));
        r.readAsArrayBuffer(file);
      });
    }

    function downloadWorkbook(workbook, originalName){
      const out = XLSX.write(workbook, { bookType:"xlsx", type:"array" });
      const blob = new Blob([out], { type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

      // Keep original file name (request C)
      const safe = (originalName || "replaceit.xlsx").replace(/\.xlsx$/i, "");
      saveAs(blob, safe + "_replaceit.xlsx");
    }

    function normalizeHeader(h){
      return String(h ?? "")
        .trim()
        .replace(/\s+/g," ")
        .toLowerCase();
    }

    // Modify only text cells
    function forEachCell(ws, fn){
      for (const addr of Object.keys(ws)){
        if (addr[0] === "!") continue;
        const cell = ws[addr];
        fn(cell, addr);
      }
    }

    // =======================
    // Tools
    // =======================
    async function previewFile(){
      const t = I18N[lang];
      if (!currentFile){
        logErr(t.needFile);
        return;
      }
      if (!await ensureLibs()) return;

      log(t.processing);

      try{
        const buf = await readFileAsArrayBuffer(currentFile);
        const wb = XLSX.read(buf, { type:"array" });

        const first = wb.SheetNames[0];
        const ws = wb.Sheets[first];

        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
        const head = rows.slice(0, 12);

        logOk(`${t.previewTitle}: ${first}\n\n` + head.map(r => JSON.stringify(r)).join("\n"));
      }catch(e){
        logErr("Preview error: " + (e && e.message ? e.message : String(e)));
      }
    }

    async function runTool(){
      const t = I18N[lang];
      if (!selectedTool){
        logErr("No tool selected.");
        return;
      }
      if (!currentFile){
        logErr(t.needFile);
        return;
      }
      if (!await ensureLibs()) return;

      log(t.processing);

      try{
        const buf = await readFileAsArrayBuffer(currentFile);
        const wb = XLSX.read(buf, { type:"array" });

        const id = selectedTool.id;

        if (id === "split_sheets"){
          await toolSplitSheets(wb, currentFile.name);
          logOk(t.doneZip);
          return;
        }

        if (id === "unify_sheets"){
          const out = toolUnifySheetsSmart(wb);
          downloadWorkbook(out, currentFile.name);
          logOk(t.doneDownload);
          return;
        }

        // Other tools: modify in-place and download
        if (id === "dot_comma") toolReplaceText(wb, ".", ",");
        if (id === "comma_dot") toolReplaceText(wb, ",", ".");
        if (id === "remove_$") toolReplaceText(wb, "$", "");
        if (id === "usd") toolReplaceText(wb, "$", "USD");
        if (id === "trim") toolTrimText(wb);
        if (id === "normalize_spaces") toolNormalizeSpaces(wb);
        if (id === "scale_1000") toolScaleNumbers(wb, 1000);
        if (id === "scale_10000") toolScaleNumbers(wb, 10000);

        downloadWorkbook(wb, currentFile.name);
        logOk(t.doneDownload);

      }catch(e){
        logErr("Process error: " + (e && e.message ? e.message : String(e)));
      }
    }

    function toolReplaceText(wb, from, to){
      wb.SheetNames.forEach(name => {
        const ws = wb.Sheets[name];
        forEachCell(ws, (cell) => {
          // only text-like cells
          if (!cell) return;
          if (cell.t === "s" || cell.t === "str") {
            const v = String(cell.v ?? "");
            if (v.includes(from)) cell.v = v.split(from).join(to);
          }
        });
      });
    }

    function toolTrimText(wb){
      wb.SheetNames.forEach(name => {
        const ws = wb.Sheets[name];
        forEachCell(ws, (cell) => {
          if (!cell) return;
          if (cell.t === "s" || cell.t === "str") {
            cell.v = String(cell.v ?? "").trim();
          }
        });
      });
    }

    function toolNormalizeSpaces(wb){
      wb.SheetNames.forEach(name => {
        const ws = wb.Sheets[name];
        forEachCell(ws, (cell) => {
          if (!cell) return;
          if (cell.t === "s" || cell.t === "str") {
            cell.v = String(cell.v ?? "").replace(/\s+/g, " ").trim();
          }
        });
      });
    }

    function toolScaleNumbers(wb, divisor){
      wb.SheetNames.forEach(name => {
        const ws = wb.Sheets[name];
        forEachCell(ws, (cell) => {
          if (!cell) return;
          // numeric only; don't touch formulas
          if (cell.t === "n" && typeof cell.v === "number") {
            cell.v = cell.v / divisor;
          }
        });
      });
    }

    function toolUnifySheetsSmart(wb){
      // Strategy:
      // - Take row 1 as headers for each sheet
      // - Build union of normalized header keys
      // - For each sheet, map header index positions to unified keys
      // - Append all rows (starting row 2) into unified sheet
      const out = XLSX.utils.book_new();

      const unifiedHeaders = [];
      const headerKeyToName = new Map(); // key -> original display name

      const sheetInfos = wb.SheetNames.map(sname => {
        const ws = wb.Sheets[sname];
        const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true });
        const headerRow = (rows[0] || []).map(h => (h ?? "").toString().trim());
        const headerKeys = headerRow.map(h => normalizeHeader(h));
        // Build union
        headerRow.forEach((h, idx) => {
          const key = headerKeys[idx];
          if (!key) return;
          if (!headerKeyToName.has(key)){
            headerKeyToName.set(key, h || key);
            unifiedHeaders.push(key);
          }
        });
        return { sname, rows, headerRow, headerKeys };
      });

      // Final header names in output
      const outHeaderRow = unifiedHeaders.map(k => headerKeyToName.get(k) || k);

      const outRows = [ outHeaderRow ];

      for (const info of sheetInfos){
        const { rows, headerKeys } = info;
        for (let r = 1; r < rows.length; r++){
          const row = rows[r] || [];
          // Create unified row
          const outRow = new Array(unifiedHeaders.length).fill("");
          for (let c = 0; c < headerKeys.length; c++){
            const key = headerKeys[c];
            if (!key) continue;
            const outIdx = unifiedHeaders.indexOf(key);
            if (outIdx >= 0){
              outRow[outIdx] = row[c] ?? "";
            }
          }
          // Skip fully empty rows
          if (outRow.every(v => v === "" || v === null || typeof v === "undefined")) continue;
          outRows.push(outRow);
        }
      }

      const outWs = XLSX.utils.aoa_to_sheet(outRows);

      // Request B: output sheet name default "replaceit"
      XLSX.utils.book_append_sheet(out, outWs, "replaceit");
      return out;
    }

    async function toolSplitSheets(wb, originalName){
      // ZIP with one workbook per sheet
      const zip = new JSZip();
      for (const sheetName of wb.SheetNames){
        const ws = wb.Sheets[sheetName];
        const newWb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(newWb, ws, sheetName);
        const out = XLSX.write(newWb, { bookType:"xlsx", type:"array" });
        zip.file(`${sheetName}.xlsx`, out);
      }

      const blob = await zip.generateAsync({ type:"blob" });
      const base = (originalName || "replaceit.xlsx").replace(/\.xlsx$/i, "");
      saveAs(blob, base + "_sheets.zip");
    }

    // =======================
    // Init
    // =======================
    function init(){
      setupDrop();

      // basic router
      function route(){
        const h = (location.hash || "").replace(/^#/, "");
        if (h.startsWith("tool/")){
          const id = h.slice("tool/".length);
          $("homeView").style.display = "none";
          $("actionView").style.display = "";
          selectedTool = { id };
          loadAction(id);
          return;
        }
        $("homeView").style.display = "";
        $("actionView").style.display = "none";
      }
      window.addEventListener("hashchange", route);

      applyLang();
      route();

      // Initial log with libs status (silent)
      log("");
      // Attempt load libs in background; show only if user tries to process without them.
      window.__LIBS_READY__.catch(()=>{});
    }

    init();
  </script>
</body>
</html>
